<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Working Group Two RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Working Group Two Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-114662288-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Changing the color of your bulbs: The fancy way | Working Group Two</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://www.wgtwo.com//img/preview.png"><meta data-react-helmet="true" name="twitter:image" content="https://www.wgtwo.com//img/preview.png"><meta data-react-helmet="true" property="og:url" content="https://www.wgtwo.com//blog/mqtt-event-bridge/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="og:description" content="We help mobile operators innovate at scale, reduce cost and dive into new revenue streams - by building a mobile core network from the ground up and delivering it as-a-service."><meta data-react-helmet="true" name="og:image" content="img/wgtwo-logo-white-bg.png"><meta data-react-helmet="true" property="og:title" content="Changing the color of your bulbs: The fancy way | Working Group Two"><meta data-react-helmet="true" name="description" content="last hackathon i did setup a mqtt integration towards wgtwo&#x27;s apis to enable call notifications via my ikea trådfri bulb so i can finally notice my wife calling me. the bulb changes color when my phone is ringing and when I am in a call, without me needing to install anything to my phone."><meta data-react-helmet="true" property="og:description" content="last hackathon i did setup a mqtt integration towards wgtwo&#x27;s apis to enable call notifications via my ikea trådfri bulb so i can finally notice my wife calling me. the bulb changes color when my phone is ringing and when I am in a call, without me needing to install anything to my phone."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-01-07T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://www.linkedin.com/in/gunnaringe/"><meta data-react-helmet="true" property="article:tag" content="api,grpc,mqtt,node-red"><link data-react-helmet="true" rel="icon" href="/img/favicons/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://www.wgtwo.com//blog/mqtt-event-bridge/"><link data-react-helmet="true" rel="alternate" href="https://www.wgtwo.com//blog/mqtt-event-bridge/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.wgtwo.com//blog/mqtt-event-bridge/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.9a17149c.css">
<link rel="preload" href="/assets/js/runtime~main.f567d3ea.js" as="script">
<link rel="preload" href="/assets/js/main.b4708e61.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="wgtwo Logo" class="themedImage_W2Cr themedImage--light_TfLj" height="32px" width="191px"><img src="/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_W2Cr themedImage--dark_oUvU" height="32px" width="191px"></div></a><a class="navbar__item navbar__link" target="_self" href="/technology/">Technology</a><a class="navbar__item navbar__link" target="_self" href="/product-ecosystem/">Product Ecosystem</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/team/">Join the Team 🎉</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link sign-up" href="/request-demo/">Talk to an Expert</a><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/manual-on-me-matt-long/">Manual on Me: Matt Long</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/please-dont-leave-a-message-after-the-beep/">Don&#x27;t leave a message after the beep</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/the-specs-behind-the-specs-part-1/">The specs behind the specs part 1</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/log4j-security-vulnerability/">Zero-day vulnerabilities - Log4j</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/ckh-iod-wg2-public-cloud/">CKH IOD selects Working Group Two for public cloud core network</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/mitsui-knowledge-industry-mki-private-networks-business/">Mitsui Knowledge Industry (MKI) to develop private networks business</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kafka-timers/">Kafka timers</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/blog/mqtt-event-bridge/">Changing the color of your bulbs: The fancy way</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/forbidden-lore-hacking-dns-routing-for-k8s/">Forbidden lore: hacking DNS routing for k8s</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/were-all-grownups-here/">We&#x27;re all grownups here</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/hackdays-october-2020/">October Virtual Hackdays</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/what-is-a-short-message/">What the heck is a short message?</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/a-new-hope-for-products-in-telecom/">A new hope for products in telecom</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/building-software-for-a-telecom-core-network/">Building software for a telecom core network</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/choosing-erlang-formatter/">Choosing an Erlang formatter</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/vowifi-imsi-leak/">VoWifi leaking IMSI</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/extending-k8s/">Extending Kubernetes for our needs</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/metrics-unlimited-thanos/">Towards observability nirvana: infinite metric retention with Thanos</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/replacing-jenkins-with-concourse/">We killed the butler: Replacing Jenkins with Concourse</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/hacking-dark-themes-with-css-blend-modes/">Hacking dark themes with CSS blend modes</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Changing the color of your bulbs: The fancy way</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-01-07T00:00:00.000Z" itemprop="datePublished">January 7, 2021</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/gunnaringe/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://media-exp1.licdn.com/dms/image/C4E03AQFnInHIEXjS7w/profile-displayphoto-shrink_400_400/0/1516312934330?e=1648684800&amp;v=beta&amp;t=FafxE3bOUsOclBJCs5mN2iXXnu3ifBW83TbjDgItL0c" alt="Gunnar Inge G. Sortland"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/gunnaringe/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Gunnar Inge G. Sortland</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer @ wgtwo</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>last hackathon i did setup a mqtt integration towards <strong>wgtwo</strong>&#x27;s apis to enable call notifications via my ikea trådfri bulb so i can finally notice my wife calling me. the bulb changes color when my phone is ringing and when I am in a call, without me needing to install anything to my phone.</p><p><img src="/assets/images/animation-0c11cc8b3879ebb39b1d24e3a5064e2c.webp" width="600" height="450"></p><hr><p>There are a variety of events generated by <strong>wgtwo</strong>’s systems for subscriptions on the platform. This includes information such as call events, SMS sent to and from a subscription (including content), voicemail events, location events, and more.</p><p>We offer a <a href="https://docs.wgtwo.com/events/listen-for-events/" target="_blank" rel="noopener noreferrer">gRPC API</a> which enables developers to listen to a selection of these events.</p><p>I wanted to make a super simple setup so that I could configure home automation rules, e.g. <strong>&quot;If someone calls me, make my IKEA bulb change color to notify me&quot;</strong> or <strong>&quot;If I send myself a SMS with &#x27;Leaf ON&#x27;, turn on the heater in my car&quot;</strong>.</p><p>A lot of home automation tools, such as Node-RED and Home Assistant have great MQTT support, so instead of writing a native gRPC integration I wanted to make a more flexible solution by offering these events over MQTT. This way, anyone using a home automation tool with MQTT support can integrate with our platform easily.</p><p>During our last hackathon I built a simple bridge between our events API and MQTT. I wrote this bridge in Go, using <a href="https://github.com/mochi-co/mqtt" target="_blank" rel="noopener noreferrer">Mochi MQTT</a> as an embedded MQTT server.</p><p>The flow is shown in this sketch:
<img src="/assets/images/sketch-8ae1c400a05f7ec61c39047a01f21288.svg" width="2567" height="765"></p><p>The way it works is quite simple: You log in to the service using our OAuth solution. You then grant the service access to fetch events on your behalf. The service will then generate a username and password for you.</p><p>The service will fetch events for all subscribers that have enabled it and publish these to the MQTT server with topic <code>{phone number}/events/{type}</code>. With the generated credentials, you may then subscribe to these events.</p><p>Note that nothing of this requires any setup on your phone, so it would work equally well on a 20-30 year old Nokia phone.</p><p>As I&#x27;ll explain in more detail below, I did setup a quick Node-RED flow to consume these events as shown in the video below:</p><h1><a target="_blank" href="/assets/files/calling-c705f71e862ebe9c9611db0cf4d5244e.mp4/">video</a></h1><p>Here you can see that:</p><ol><li>The light changes to cool white when the call is initiated (phone not yet ringing)</li><li>It turns pink when the phone is ringing</li><li>It turns red when we pick up the call</li><li>It returns to normal after the call has ended</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="connecting-to-wgtwos-api">Connecting to <strong>wgtwo</strong>&#x27;s API<a class="hash-link" href="#connecting-to-wgtwos-api" title="Direct link to heading">​</a></h2><p>We will use a normal OAuth2 authorization code grant for logging in to our service.</p><p>To handle this, we used the module <code>github.com/markbates/goth</code> with the following settings:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;golang.org/x/oauth2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> endpointProfile </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;https://id.wgtwo.com/userinfo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> Endpoint </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> oauth2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Endpoint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  AuthURL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;https://id.wgtwo.com/oauth2/auth&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  TokenURL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;https://id.wgtwo.com/oauth2/token&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>When logging in, the user will be asked to consent to the following scopes:</p><ul><li>phone: Allowing the service to fetch the user’s phone number</li><li>offline_access: Giving the service a refresh token</li><li>events.voice.subscribe: Allow the service to see all call events</li><li>events.voicemail.subscribe: Allow the service to see if a voicemail has been left</li><li>events.sms.subscribe: Allow the service to get a copy of every SMS sent and received</li></ul><p>All the events you have consented to share with the service will be stored in the service&#x27;s queue.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sms events        ─╮</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">voice events      ─┼─▷  queue  ◁── gRPC API</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">voice mail events ─╯</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This queue can be consumed by using the events streaming API (<a href="https://docs.wgtwo.com/events/listen-for-events/" target="_blank" rel="noopener noreferrer">docs</a>), which requires the service to use the OAuth2 client credentials grant flow.</p><p>Events will be shared with the service as long as there exists an active consent.</p><p>We then initiate the server side stream to fetch the events:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">request </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">pb</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">SubscribeEventsRequest</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">pb</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">EventType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">pb</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">EventType_VOICEMAIL_EVENT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  StartPosition</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">pb</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">SubscribeEventsRequest_StartAtOldestPossible</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ClientId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">      uuid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">New</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  QueueName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">     </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;wgtwo-mqtt-demo&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DurableName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">   </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;wgtwo-mqtt-demo&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  MaxInFlight</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">   </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ManualAck</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">pb</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">ManualAckConfig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     Enable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     Timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ptypes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">DurationProto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> time</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">r</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Subscribe</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">context</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">TODO</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  response</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> r</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Recv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> io</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">EOF </span><span class="token operator" style="color:rgb(137, 221, 255)">||</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  event </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Event</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// PUBLISH EVENT TO MQTT SERVER ON TOPIC {event owner}/events/{type}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="connecting-to-our-new-mqtt-service">Connecting to our new MQTT service<a class="hash-link" href="#connecting-to-our-new-mqtt-service" title="Direct link to heading">​</a></h2><p>The service has a very pretty landing page (Disclaimer: I am not a designer).</p><p><img alt="landing page" src="data:image/png;base64,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" width="1228" height="324"></p><p>Clicking this button takes you to the login page:</p><div class="post-images halves" markdown="1">![](/img/blog/mqtt-event-bridge/login-enter-phonenumber.png) ![](/img/blog/mqtt-event-bridge/login-pin.png)</div><p>… and then asks you to allow our service to get your voice event and new voicemails. As I am only interested in the voice events here, I’ll only grant that.</p><p>As this is an experimental app which hasn’t been approved by anyone, our login page will give you a clear warning about trusting this.</p><div class="post-images single" markdown="1">![](/img/blog/mqtt-event-bridge/login-consent.png)</div><p>When that is done, it returns to our app showing this beautiful UI (still not a designer):</p><p><img src="/assets/images/success-f636e03c8edb08ab9b6418c1311e02ec.png" width="1141" height="371"></p><p>The generated credentials will allow you to listen any topic matching <code>{phone number}/#</code>.</p><p>The following is the output from pasting that mosquitto_sub command in my terminal. It shows that I first called my Swedish number and hanging up before it was actually ringing.</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;event&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;metadata&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;sequence&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;ackInbox&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;_INBOX.VMTx7rnS0i3qXpHfuS5t3b&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;timestamp&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2021-01-06T11:24:40Z&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;serviceId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;wotel&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;voiceEvent&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;callId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;0c056e2c-07f9-4c2b-b5ca-042f160af42f&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;CALL_INITIATED&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;fromNumber&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;e164&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;+4712345678&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;toNumber&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;e164&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;+46123456789&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;owner&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;e164&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;+46123456789&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;event&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;metadata&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;sequence&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;ackInbox&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;_INBOX.VMTx7rnS0i3qXpHfuS5t3b&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;timestamp&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2021-01-06T11:24:43Z&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;serviceId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;wotel&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;voiceEvent&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;callId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;0c056e2c-07f9-4c2b-b5ca-042f160af42f&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;CALL_ENDED&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;fromNumber&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;e164&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;+4712345678&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;toNumber&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;e164&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;+46123456789&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;owner&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;e164&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;+46123456789&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If you run any home automation or other hobby projects at home, chances are that you already have a MQTT broker running.
You could then setup bridging to not worry about credentials and TLS when consuming your events.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="wrapping-it-all-up">Wrapping it all up<a class="hash-link" href="#wrapping-it-all-up" title="Direct link to heading">​</a></h2><p>For this project I chose to use Node-RED, as it allows for very quick and easy to show drag-and-drop integrations.</p><p>To control the lamp, we did add the module <code>node-red-contrib-tradfri</code> as described in the Node-RED <a href="https://flows.nodered.org/node/node-red-contrib-tradfri" target="_blank" rel="noopener noreferrer">documentation</a>.</p><p>First we did add a <code>mqtt out</code> node configured to listen to the topic 46123456789/# with output as a parsed JSON object using the credentials we got on login.</p><p><img src="/assets/images/nodered-debug-d8a10d5399f2a33887d3237d43e8e4bf.png" width="1146" height="718"></p><p>We then simply hooked its output to a debug node. Looking at the output, we can see that the event object has a key <code>voiceEvent</code>, as this is a voice event.</p><p><img src="/assets/images/nodered-flow-958c30eb5b4cf4b283249d90f1f81122.png" width="1108" height="233"></p><p>Then we added a switch for handling it as a voice event if the voiceEvent key exists. Likewise, we added a new switch on the type field of that event.</p><p>Each of those functions simply set the Trådfri payload, as shown below:</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token property">&quot;state&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;on&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token property">&quot;color&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cool daylight&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>As this was created quickly as a hackathon project, the intention was never to actually make anything useful. Using this quick flow, it is however clear that it could be very useful for when my wife tries to call me, but I am programming equipped with my noise-cancelling headphones.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/api/">api</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/grpc/">grpc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/mqtt/">mqtt</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/node-red/">node-red</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/working-group-two/wgtwo.com/edit/main/blog/../blog/2021-01-07-mqtt-event-bridge.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/kafka-timers/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Kafka timers</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/forbidden-lore-hacking-dns-routing-for-k8s/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Forbidden lore: hacking DNS routing for k8s</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#connecting-to-wgtwos-api" class="table-of-contents__link toc-highlight">Connecting to <strong>wgtwo</strong>&#39;s API</a></li><li><a href="#connecting-to-our-new-mqtt-service" class="table-of-contents__link toc-highlight">Connecting to our new MQTT service</a></li><li><a href="#wrapping-it-all-up" class="table-of-contents__link toc-highlight">Wrapping it all up</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items"><li class="footer__item"><a href="/"><img alt="wgtwo Logo" src="/img/logo_white.svg" width="281px" height="32px" class="footer-logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items"><li class="footer__item"><a href="https://docs.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>API Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://console.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Console Login<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://support.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Customer Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Company</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/about/introduction/">About</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/case-studies/mvnx/">Case Studies</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/team/">Team</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/careers/">Careers</a></li><li class="footer__item"><a href="https://gk.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>gk.wgtwo.com 合同会社<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Security</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/security/">Security Overview</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/technology/security-whitepaper/">Security Whitepaper</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/privacy/">Privacy Policy</a></li></ul></div><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/about/media-and-analysts/">Media &amp; Analysts</a></li><li class="footer__item"><a href="https://twitter.com/workinggrouptwo" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/working-group-two" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="http://linkedin.com/company/wgtwo" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/contact/">Contact Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2022 Working Group Two AS</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f567d3ea.js"></script>
<script src="/assets/js/main.b4708e61.js"></script>
</body>
</html>