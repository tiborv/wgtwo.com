<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Working Group Two RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Working Group Two Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-114662288-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Extending Kubernetes for our needs | Working Group Two</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://www.wgtwo.com//img/preview.png"><meta data-react-helmet="true" name="twitter:image" content="https://www.wgtwo.com//img/preview.png"><meta data-react-helmet="true" property="og:url" content="https://www.wgtwo.com//blog/extending-k8s/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="og:description" content="We help mobile operators innovate at scale, reduce cost and dive into new revenue streams - by building a mobile core network from the ground up and delivering it as-a-service."><meta data-react-helmet="true" name="og:image" content="img/wgtwo-logo-white-bg.png"><meta data-react-helmet="true" property="og:title" content="Extending Kubernetes for our needs | Working Group Two"><meta data-react-helmet="true" name="description" content="We are using Kubernetes as our cluster scheduler and this serves us well. However we have a"><meta data-react-helmet="true" property="og:description" content="We are using Kubernetes as our cluster scheduler and this serves us well. However we have a"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2020-02-21T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://www.linkedin.com/in/hihrig/"><meta data-react-helmet="true" property="article:tag" content="infrastructure,kubernetes,networking,AWS"><link data-react-helmet="true" rel="icon" href="/img/favicons/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://www.wgtwo.com//blog/extending-k8s/"><link data-react-helmet="true" rel="alternate" href="https://www.wgtwo.com//blog/extending-k8s/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.wgtwo.com//blog/extending-k8s/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.9a17149c.css">
<link rel="preload" href="/assets/js/runtime~main.4eea459e.js" as="script">
<link rel="preload" href="/assets/js/main.b4708e61.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="wgtwo Logo" class="themedImage_W2Cr themedImage--light_TfLj" height="32px" width="191px"><img src="/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_W2Cr themedImage--dark_oUvU" height="32px" width="191px"></div></a><a class="navbar__item navbar__link" target="_self" href="/technology/">Technology</a><a class="navbar__item navbar__link" target="_self" href="/product-ecosystem/">Product Ecosystem</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/team/">Join the Team 🎉</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link sign-up" href="/request-demo/">Talk to an Expert</a><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/manual-on-me-matt-long/">Manual on Me: Matt Long</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/please-dont-leave-a-message-after-the-beep/">Don&#x27;t leave a message after the beep</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/the-specs-behind-the-specs-part-1/">The specs behind the specs part 1</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/log4j-security-vulnerability/">Zero-day vulnerabilities - Log4j</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/ckh-iod-wg2-public-cloud/">CKH IOD selects Working Group Two for public cloud core network</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/mitsui-knowledge-industry-mki-private-networks-business/">Mitsui Knowledge Industry (MKI) to develop private networks business</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kafka-timers/">Kafka timers</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/mqtt-event-bridge/">Changing the color of your bulbs: The fancy way</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/forbidden-lore-hacking-dns-routing-for-k8s/">Forbidden lore: hacking DNS routing for k8s</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/were-all-grownups-here/">We&#x27;re all grownups here</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/hackdays-october-2020/">October Virtual Hackdays</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/what-is-a-short-message/">What the heck is a short message?</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/a-new-hope-for-products-in-telecom/">A new hope for products in telecom</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/building-software-for-a-telecom-core-network/">Building software for a telecom core network</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/choosing-erlang-formatter/">Choosing an Erlang formatter</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/vowifi-imsi-leak/">VoWifi leaking IMSI</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/blog/extending-k8s/">Extending Kubernetes for our needs</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/metrics-unlimited-thanos/">Towards observability nirvana: infinite metric retention with Thanos</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/replacing-jenkins-with-concourse/">We killed the butler: Replacing Jenkins with Concourse</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/hacking-dark-themes-with-css-blend-modes/">Hacking dark themes with CSS blend modes</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Extending Kubernetes for our needs</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-02-21T00:00:00.000Z" itemprop="datePublished">February 21, 2020</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/hihrig/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://media-exp1.licdn.com/dms/image/C5603AQGc3sG-ltGzlA/profile-displayphoto-shrink_400_400/0/1516250699138?e=1648684800&amp;v=beta&amp;t=qpxr39O2hNY54vsUcCbt1wH8fc2lMf07zW1etQD_gxY" alt="Holger Ihrig"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/hihrig/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Holger Ihrig</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer @ wgtwo</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>We are using Kubernetes as our cluster scheduler and this serves us well. However we have a
few cases where we need to do some additional work.</p><p>One case for example is that we have to use static IPs for some of our services to connect to
Telecom companies as they expect a single IP address to bind to. This address needs to be fixed and
DNS records are not accepted either. We are running in AWS as well, so the reader might ask why are we not
using Elastic IPs and adding them to the services? Good idea, but Telecom operators will not whitelist
an Elastic IP for you as there are no guarantees that it will belong to your company infrastructure forever. There
are also additional challenges when it comes to using Elastic IP in private subnet over VPN or direct connect.</p><p>We are a member of RIPE and do have a small subnet block for our own use, so we thought we could make use of
that. As we own the block and AWS supports BYOIP (Bring your own IP-range), we created a special subnet with
some Kubernetes nodes in it. This was not enough to make this work since we depended on a service always having
the same IP attached to it, as well as the node running a pod having some very specific Routes set.</p><p>With this scenario in mind we set out to find solutions and all solutions we could think of required haggling
with Kubernetes.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="extending-kubernetes">Extending Kubernetes<a class="hash-link" href="#extending-kubernetes" title="Direct link to heading">​</a></h2><p>There are several ways to extend Kubernetes. All functionality in Kubernetes is build upon very nice and clean
public APIs, or to say it with other words: There is no private API magic hidden somewhere. So lets look at
two ways on how to extend Kubernetes.</p><p>Possible ways to go forward:</p><ul><li>Adding a scheduler extender</li><li>Creating an operator/controller</li></ul><p>There are more ways to extend Kubernetes, but these two ways will be the one we shall look at. Just for completeness
you can as well also add another scheduler or change Kubernetes itself. However these possibilities have some serious
downsides.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="adding-a-scheduler-extender">Adding a scheduler extender<a class="hash-link" href="#adding-a-scheduler-extender" title="Direct link to heading">​</a></h3><p>The Kubernetes scheduler checks for certain requirements before it schedules a pod onto a node. Some of these requirements
are hard requirements, like cpu, memory and number of pods. Other requirements are more soft, like if the pods are allowed to
be packed together or in which AZ they are going to run. All of those requirements are collected and points given to each
node on how well they meet the requirements. The node that fits best, gets chosen.</p><p>All of these are things the scheduler will do for you automatically, however it is also possible to give the cluster a
<code>KubeSchedulerConfiguration</code> object that will tell the scheduler to also reach out to a service for additional point scoring.
The SchedulerConfiguration is a JSON file and for further explanations, please have a look at this
excellent <a href="https://developer.ibm.com/articles/creating-a-custom-kube-scheduler/" target="_blank" rel="noopener noreferrer">blog post</a>.</p><p>In our case, we could have written a service that checks which IP Addresses are assigned to the Nodes and moved the Pods
onto those nodes. This would have required us to make sure that those nodes had all needed IP-Addresses all the time.
That sounded not very enticing when doing cluster upgrades as it would have needed to be at least a semi-manual process.
So we decided against this approach.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="creating-an-operator">Creating an operator<a class="hash-link" href="#creating-an-operator" title="Direct link to heading">​</a></h3><p>An Operator/Controller on the other hand is a component observing resources and then try to create the declared resources.
The difference between a controller and an operator is basically that an operator is handling the lifecycle of an
application, whereas a controller may control specific resources that are not associated with a specific application.
They both use the controller pattern though and both can be implemented with the same toolset, so for simplicity sake in the
context of this article, we will consider them to be equal.</p><p>Operators usually consists at least out of a <strong><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank" rel="noopener noreferrer">CRD(CustomResourceDefinition)</a></strong>, an <strong>event listener</strong> and a <strong>reconciliation loop</strong>.
The <em>CRD</em> basically creates a new type of resource and effectively implements a domain specific language for the operator. The whole description on what this deployment
needs to look like and all its abilities need to be defined in the <em>CRD</em>. The operator will create an <em>event listener</em> for that
<em>CRD</em> as the primary resource and additional <em>event listeners</em> for the secondary resource (most likely pods in this example).
The <em>event listener</em> will let the <em>reconciliation loop</em> know once a <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete" target="_blank" rel="noopener noreferrer">CRUD</a> operation has been requested on either the primary or
secondary resource. The <em>loop</em> will then try to bring the <em>CRD</em> into the desired state, depending on what operation has been
requested. So in the Redis example it will either create the pods, update the pods, in the case of an upgrade it might blue/green
deploy the pods or delete the pods. Basically things a human operator would do in this case, just in programmatic form, taking it
from a declarative form into existing resources.</p><p>As our initial problem was making services available on static IP addresses, we chose to explore this approach further,
basically attaching additional IP addresses to the nodes running specific pods.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-an-operatorcontroller">Building an Operator/Controller<a class="hash-link" href="#building-an-operatorcontroller" title="Direct link to heading">​</a></h2><p>For building an operator, there are several frameworks out there, but we will only look at the <a href="https://github.com/operator-framework/operator-sdk" target="_blank" rel="noopener noreferrer">operator-framework</a> in
this article.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="operator-sdk">Operator-SDK<a class="hash-link" href="#operator-sdk" title="Direct link to heading">​</a></h3><p>The Operator framework is a project that is designed to help you get started on creating an operator. To achieve that,
it will generate quite a bit of boilerplate.</p><p>The Operator-SDK supports three different models of creating an operator:</p><ul><li>Helm</li><li>Ansible</li><li>Golang</li></ul><p>Depending on your choice of tool, you will be able to integrate deeper into Kubernetes or not.</p><p><img alt="operator-sdk-capabilites" src="/assets/images/operator-capability-level-f511b5d60b3e9160a4582577204888cd.png" title="Operator sdk capabilities (Taken from the operator-sdk repo)" width="2440" height="1200">
<em><a href="https://github.com/operator-framework/operator-sdk/blob/master/README.md" target="_blank" rel="noopener noreferrer">Operator sdk capabilities</a></em></p><p>As we didn&#x27;t want to be limited by our choice later on and wanted to expose metrics from our operator, we chose to
implement our operator in golang. We will be using the operator-sdk version 0.12 for this.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="what-we-want-to-do">What we want to do<a class="hash-link" href="#what-we-want-to-do" title="Direct link to heading">​</a></h3><p>Looking at the problem again, we need some way to make sure that a node that runs a specific pod, needs to
have an IP address attached to it. This IP address will be given to connecting parties as a entry point to our
system and thus cannot change.</p><p>Features it needs to support</p><ul><li>Reserve IP address from range</li><li>Attach IP address to node running pod</li><li>Detach IP address from node that is not running pod</li><li>Move IP addresses around in case of node failure</li></ul><p>This feature list already shows some things we will not and most likely cannot support. For example autoscaling of
replica sets will not work as an IP address is bound to a node with an assigned pod. There is
a 1-1 association here. However it is still possible to use the self-healing properties of Deployments
in this case.</p><p>When thinking about modelling this behaviour, we basically decided on the following approach:</p><ul><li>Create a IP kind (for reserving the IP Address in the Range)</li><li>Use annotations to attach the IP Address to a pod</li></ul><p>We also thought about creating a StaticIPDeployment kind, but at the end decided against it, as
we feared that the lifecycle management would be way more complicated if we needed to manage a deployment
instead of just controlling the assignment of an IP Address.</p><p>After all this is the first Operator we are going to write and didn&#x27;t want to drown in complexity from day one.
We would rather iterate and scrap everything after we tried it, then going too complex from the start.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="implementation">Implementation<a class="hash-link" href="#implementation" title="Direct link to heading">​</a></h3><p>The first thing you do when starting off a new operator, is that you initialize the directory of your
operator with the following command:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">operator-sdk new app-operator --repo &lt;YOURREPO&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This will create some boilerplate folders and files for you and will look roughly like this:</p><p><img alt="operator-fs-structure" src="/assets/images/operator-structure-1a847ce462732788fdab91235ce1a528.png" title="Operator Folder Structure" width="351" height="169"></p><p>The next thing you might want to do is then add the boilerplate for a CRD and a Controller:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">operator-sdk add api --api-version=ip.wgtwo.com/v1alpha1 --kind=IP</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">operator-sdk add controller --api-version=ip.wgtwo.com/v1alpha1 --kind=IP</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After creating the boilerplate, your folder structure will look a lot like this:</p><p><img alt="operator-fs-structure-expanded" src="/assets/images/operator-structure-expanded-5901aa50d6e40055e6140151f960b40f.png" title="Operator Folder Structure Expanded" width="335" height="536"></p><p>The most important files right now are in:</p><ul><li>cmd/manager/main.go (the main program that will run in the cluster)</li><li>pkg/apis/ip/v1alpha1/ip_types.go (definition of the CRD)</li><li>pkg/controller/ip_controller.go (event listener and reconciliation loop)</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="creating-the-crd">Creating the CRD<a class="hash-link" href="#creating-the-crd" title="Direct link to heading">​</a></h4><p>To start off, we define how our CRD should look like to be able to manage our IP Address. We do this,
by creating structs in go that have all the fields our CRD shall have. This includes metadata, &quot;spec&quot; and
&quot;status&quot; fields.</p><p>There is also a bit of operator-sdk specific code we need to add. This is so that the sdk can generate the
openapi spec and other auto-generated code.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// +k8s:openapi-gen=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// +kubebuilder:subresource:status</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// +kubebuilder:resource:path=ips,scope=Cluster</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">type IP struct {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    metav1.TypeMeta   `json:&quot;,inline&quot;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Spec   IPSpec   `json:&quot;spec,omitempty&quot;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Status IPStatus `json:&quot;status,omitempty&quot;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The &quot;spec&quot; needs to contain all information the controller needs to create the resource.
The &quot;status&quot; part needs to contain all the bookkeeping information the controller needs to work. In a way the
&quot;status&quot; fields are used as a database for operating Kubernetes (yes, this is oversimplified).</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// +k8s:openapi-gen=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">type IPSpec struct {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Address string `json:&quot;address&quot;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Reassign bool `json:&quot;reassign,omitempty&quot;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// IPStatus defines the observed state of IP</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// +k8s:openapi-gen=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">type IPStatus struct {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Assigned bool   `json:&quot;assigned&quot;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Claimed  bool   `json:&quot;claimed&quot;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Node     string `json:&quot;node,omitempty&quot;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Pod      string `json:&quot;pod,omitempty&quot;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Original IPSpec `json:&quot;original,omitempty&quot;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>As you can see our new IP Resource type, as defined by the CRD that we are gonna create from these structs, is
going to have two fields: &quot;Address&quot; and &quot;Reassign&quot;.
The corresponding &quot;status&quot; part of the resource, has a lot more fields, which we are using for bookkeeping.</p><p>After we have created those structs and know how the CRD needs to look like, we actually auto-generate the CRD yaml:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">operator-sdk generate k8s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">operator-sdk generate openapi</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>NB: This changed since operator-sdk 0.15</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="creating-the-controller">Creating the controller<a class="hash-link" href="#creating-the-controller" title="Direct link to heading">​</a></h4><p>There are two main parts to the controller. One part that creates a watcher on resources and one part
that reconciles your resource (in our case the IP and Pods).</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="watching-for-resource-changes">Watching for resource changes<a class="hash-link" href="#watching-for-resource-changes" title="Direct link to heading">​</a></h5><p>The watch code is in our case in the <code>add</code> function of ip_controller.go:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // Watch for changes to primary resource IP, as this always requires an action</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    err = c.Watch(&amp;source.Kind{Type: &amp;ipv1alpha1.IP{}}, &amp;handler.EnqueueRequestForObject{})</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // Create Filter list triggering on ip.wgtwo.com/ip as annotation</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pred := predicate.Funcs{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // Ignore the pod if it does not contain annotation ip.wgtwo.com/ip</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        CreateFunc: func(e event.CreateEvent) bool {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return hasAnnotation(e.Meta)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        UpdateFunc: func(e event.UpdateEvent) bool {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            if hasAnnotation(e.MetaOld) || hasAnnotation(e.MetaNew){</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                return true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                return false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        DeleteFunc: func(e event.DeleteEvent) bool {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            // Evaluates to false if the object has been confirmed deleted.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return !e.DeleteStateUnknown</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // Watch for all pods having the right annotation</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    err = c.Watch(&amp;source.Kind{Type: &amp;corev1.Pod{}}, &amp;handler.EnqueueRequestForObject{}, pred)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here we are creating watchers for all changes to the <code>IP</code> resource and watchers for all create/update/delete operations on
pods, if they have a specific annotation set.</p><p>If any of these conditions are met, the reconciliation loop will be triggered.</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="reconciliation">Reconciliation<a class="hash-link" href="#reconciliation" title="Direct link to heading">​</a></h5><p>This is where the business logic of your operator/controller is sitting. The <code>Reconcile</code> function in <code>ip_controller.go</code> will
be triggered whenever one of the watch conditions fits.
We do not know which type of resource triggered the loop, so that is the first thing we need to figure out:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">oip := &amp;ipv1alpha1.IP{}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">err := r.client.Get(context.TODO(), request.NamespacedName, oip)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if err == nil {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ... yes it is a resource of kind IP ... go and do business</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">op := &amp;corev1.Pod{}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">err = r.client.Get(context.TODO(), request.NamespacedName, op)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if err == nil {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ... yes it is a resource of kind Pod ... go and do business</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In these two code blocks, we are handling all the interactions for the primary resource of kind IP and the secondary
resource of type pod. Depending on what has happened last we have different scenarios.</p><p>Cases for the IP resource to consider:</p><ul><li>IP is new</li><li>IP has been modified</li><li>IP has been deleted</li></ul><p>Cases for the Pod resource to consider:</p><ul><li>Annotation sticking the IP to the pod has been deleted</li><li>IP needs to be assigned to a pod</li><li>Pod has moved to another node</li><li>Pod has been deleted</li></ul><p>We will not go any further into the detail on what these parts are actually doing, as this is enough
to actually give you an idea on how this can be accomplished.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">​</a></h2><p>We have been looking at how to expand Kubernetes to suit our needs better. Creating the Operator/Controller
has taught us quite a bit about how Kubernetes works and has already saved us work in the past
few months, especially on node failures.</p><p>The operator-sdk has been a great tool for us to solve this problem and we see that there is a lot of work
going into it, making it simpler to create operators. It might look intimidating at first, but is worth the effort and
we think in the future Kubernetes operators will be the way how stateful components will be managed.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="resources--further-reading">Resources / Further Reading<a class="hash-link" href="#resources--further-reading" title="Direct link to heading">​</a></h2><ul><li>Programming Kubernetes by Stefan Schimanski and Michael Hausenblas</li><li><a href="https://developer.ibm.com/articles/creating-a-custom-kube-scheduler/" target="_blank" rel="noopener noreferrer">Creating a custom kube-scheduler</a></li><li><a href="https://github.com/operator-framework/operator-sdk" target="_blank" rel="noopener noreferrer">Operator SDK</a></li></ul></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/infrastructure/">infrastructure</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubernetes/">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/networking/">networking</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/aws/">AWS</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/working-group-two/wgtwo.com/edit/main/blog/../blog/2020-02-21-Extending-Kubernetes-Static-IP-Routing.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/vowifi-imsi-leak/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">VoWifi leaking IMSI</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/metrics-unlimited-thanos/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Towards observability nirvana: infinite metric retention with Thanos</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#extending-kubernetes" class="table-of-contents__link toc-highlight">Extending Kubernetes</a><ul><li><a href="#adding-a-scheduler-extender" class="table-of-contents__link toc-highlight">Adding a scheduler extender</a></li><li><a href="#creating-an-operator" class="table-of-contents__link toc-highlight">Creating an operator</a></li></ul></li><li><a href="#building-an-operatorcontroller" class="table-of-contents__link toc-highlight">Building an Operator/Controller</a><ul><li><a href="#operator-sdk" class="table-of-contents__link toc-highlight">Operator-SDK</a></li><li><a href="#what-we-want-to-do" class="table-of-contents__link toc-highlight">What we want to do</a></li><li><a href="#implementation" class="table-of-contents__link toc-highlight">Implementation</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#resources--further-reading" class="table-of-contents__link toc-highlight">Resources / Further Reading</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items"><li class="footer__item"><a href="/"><img alt="wgtwo Logo" src="/img/logo_white.svg" width="281px" height="32px" class="footer-logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items"><li class="footer__item"><a href="https://docs.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>API Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://console.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Console Login<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://support.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Customer Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Company</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/about/introduction/">About</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/case-studies/mvnx/">Case Studies</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/team/">Team</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/careers/">Careers</a></li><li class="footer__item"><a href="https://gk.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>gk.wgtwo.com 合同会社<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Security</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/security/">Security Overview</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/technology/security-whitepaper/">Security Whitepaper</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/privacy/">Privacy Policy</a></li></ul></div><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/about/media-and-analysts/">Media &amp; Analysts</a></li><li class="footer__item"><a href="https://twitter.com/workinggrouptwo" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/working-group-two" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="http://linkedin.com/company/wgtwo" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/contact/">Contact Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2022 Working Group Two AS</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4eea459e.js"></script>
<script src="/assets/js/main.b4708e61.js"></script>
</body>
</html>